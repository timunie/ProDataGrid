# Column Definitions: Hierarchical Columns

Column definitions work with hierarchical grids by binding to `HierarchicalNode` and using `DataGridHierarchicalColumnDefinition` for the expander column. This keeps the column model in your view model while still supporting fast-path sorting, filtering, and searching.

## Define columns for hierarchical nodes

Define bindings against `HierarchicalNode` and project to your item type. The accessor generated by `DataGridBindingDefinition` is used by fast-path models.

```csharp
private static DataGridBindingDefinition CreateNodeBinding<TValue>(string name, Func<TreeItem, TValue> getter)
{
    return ColumnDefinitionBindingFactory.CreateBinding<HierarchicalNode, TValue>(
        name,
        node => getter((TreeItem)node.Item));
}

_nameColumn = new DataGridHierarchicalColumnDefinition
{
    Header = "Item",
    Binding = CreateNodeBinding<TreeItem>("Item", item => item),
    CellTemplateKey = "HierarchyNameTemplate",
    SortMemberPath = "Item.Name",
    Width = new DataGridLength(2, DataGridLengthUnitType.Star)
};

_idColumn = new DataGridTextColumnDefinition
{
    Header = "Id",
    Binding = CreateNodeBinding<int>("Id", item => item.Id),
    SortMemberPath = "Item.Id"
};
```

`SortMemberPath` is optional, but it helps map model descriptors back to columns when you want explicit ids or persistence.

## XAML wiring

```xml
<DataGrid ColumnDefinitionsSource="{Binding ColumnDefinitions}"
          HierarchicalModel="{Binding Model}"
          HierarchicalRowsEnabled="True"
          SortingModel="{Binding SortingModel}"
          FilteringModel="{Binding FilteringModel}"
          SearchModel="{Binding SearchModel}"
          SortingAdapterFactory="{StaticResource HierarchicalSortingAdapterFactory}"
          FilteringAdapterFactory="{StaticResource AccessorFilteringAdapterFactory}"
          SearchAdapterFactory="{StaticResource AccessorSearchAdapterFactory}"
          AutoGenerateColumns="False" />
```

The sorting adapter is optional; it is useful when you want header clicks to update the sorting model but apply sorting inside the hierarchical model instead of the flattened view. The accessor adapter factory names are examples; implement them in your app to avoid reflection.

## Sorting in hierarchical models

Hierarchical grids should sort siblings in the model instead of reordering the flattened view. Use the sorting model to collect descriptors, then apply a comparer to the hierarchical model:

```csharp
private void OnSortingChanged(object sender, SortingChangedEventArgs e)
{
    var comparers = BuildComparers(e.NewDescriptors);
    var composite = Comparer<TreeItem>.Create((x, y) =>
    {
        foreach (var entry in comparers)
        {
            var result = entry.Comparer.Compare(x, y);
            if (result != 0)
            {
                return entry.Direction == ListSortDirection.Descending ? -result : result;
            }
        }
        return 0;
    });

    Model.ApplySiblingComparer(composite, recursive: true);
}
```

If you handle sorting in the model, use a sorting adapter that short-circuits view sorting.

## Filtering while keeping parents

Hierarchical filters often keep ancestor nodes of matches so users can see the path. Build a match set and use a custom predicate:

```csharp
var matches = BuildMatchSet(RootItems, filterText);
FilteringModel.SetOrUpdate(new FilteringDescriptor(
    columnId: _nameColumn,
    @operator: FilteringOperator.Custom,
    predicate: item => MatchesFilter(item, matches)));
```

Use an accessor-based filtering adapter so filtering does not fall back to reflection.

## Searching and highlights

Search uses column text. Supply a text provider or ensure `ToString()` returns a useful value for hierarchical items:

```csharp
DataGridColumnSearch.SetTextProvider(_nameColumn, item => ((TreeItem)item).Name);
```

With a search adapter that uses value accessors, search remains reflection-free and supports highlights.

## Streaming updates

For frequent updates, use observable root collections and keep the hierarchical model as the source of truth. When updates change values that affect sorting or filtering, reapply the model logic (for example, re-run `ApplySiblingComparer`).

## Related articles

- [Column Definitions](column-definitions.md)
- [Column Definitions (Model Integration)](column-definitions-models.md)
- [Column Definitions (Hot Path Integration)](column-definitions-hot-path.md)
- [Hierarchical Data](hierarchical-data.md)
